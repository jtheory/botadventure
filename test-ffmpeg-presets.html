<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFmpeg Preset Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        h1 {
            color: #00bfff;
            margin-bottom: 20px;
            text-align: center;
        }

        .controls {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .file-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-input {
            flex: 1;
        }

        .file-input label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }

        .file-input input[type="file"] {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .preset-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
        }

        .preset-card:hover {
            border-color: #00bfff;
            transform: translateY(-2px);
        }

        .preset-card.running {
            border-color: #ff8800;
            background: #2a2a1a;
        }

        .preset-card.success {
            border-color: #00ff00;
            background: #1a2a1a;
        }

        .preset-card.error {
            border-color: #ff0000;
            background: #2a1a1a;
        }

        .preset-name {
            font-weight: bold;
            color: #00bfff;
            margin-bottom: 5px;
        }

        .preset-description {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }

        .preset-button {
            width: 100%;
            padding: 8px;
            background: #00bfff;
            border: none;
            border-radius: 4px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .preset-button:hover:not(:disabled) {
            background: #0099cc;
        }

        .preset-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .preset-result {
            margin-top: 10px;
            font-size: 12px;
        }

        .preset-video {
            width: 100%;
            margin-top: 10px;
            border-radius: 4px;
        }

        .stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 11px;
        }

        .stat {
            background: #1a1a1a;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .log-container {
            background: #000;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
        }

        .log-error { color: #ff6666; }
        .log-success { color: #66ff66; }
        .log-info { color: #6666ff; }
        .log-warning { color: #ffff66; }

        .batch-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .batch-button {
            padding: 10px 20px;
            background: #6c757d;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .batch-button:hover {
            background: #5a6268;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #00bfff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .comparison-table {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        th {
            color: #00bfff;
            font-weight: bold;
        }

        .best { color: #00ff00; }
        .worst { color: #ff6666; }
    </style>
</head>
<body>
    <h1>üé¨ FFmpeg Preset Tester</h1>

    <div class="controls">
        <div class="file-inputs">
            <div class="file-input">
                <label for="audioFile">Audio File (Required)</label>
                <input type="file" id="audioFile" accept="audio/*">
            </div>
            <div class="file-input">
                <label for="imageFile">Image File (Optional - black background if not provided)</label>
                <input type="file" id="imageFile" accept="image/*">
            </div>
        </div>

        <div class="batch-controls">
            <button class="batch-button" onclick="runAllTests()">üöÄ Run All Tests</button>
            <button class="batch-button" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <button class="batch-button" onclick="downloadComparison()">üìä Download Comparison</button>
        </div>
    </div>

    <div class="preset-grid" id="presetGrid">
        <!-- Preset cards will be generated here -->
    </div>

    <div class="comparison-table" id="comparisonTable" style="display: none;">
        <h3>üìä Comparison Results</h3>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Preset</th>
                    <th>File Size</th>
                    <th>Video Duration</th>
                    <th>Generation Time</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <div class="log-container" id="logContainer">
        <div id="log"></div>
    </div>

    <script type="module">
        // We need to import the compiled JavaScript, not TypeScript
        // During dev, Vite will handle the transformation
        import('/src/utils/ffmpegCore.ts').then(module => {
            const { getFFmpeg, runConversion, runTwoPassConversion, conversionPresets, probeFile } = module;

        const logEl = document.getElementById('log');
        const presetGrid = document.getElementById('presetGrid');
        const results = {};
        let audioFile = null;
        let imageFile = null;

        function log(msg, type = '') {
            console.log(msg);
            const timestamp = new Date().toTimeString().slice(0, 8);
            const className = type ? `log-${type}` : '';
            logEl.innerHTML += `<div class="log-line ${className}">${timestamp} ${msg}</div>`;
            logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
        }

        // File input handlers
        document.getElementById('audioFile').addEventListener('change', (e) => {
            audioFile = e.target.files[0];
            if (audioFile) {
                log(`Audio loaded: ${audioFile.name} (${(audioFile.size / 1024).toFixed(2)} KB)`, 'info');
            }
        });

        document.getElementById('imageFile').addEventListener('change', (e) => {
            imageFile = e.target.files[0];
            if (imageFile) {
                log(`Image loaded: ${imageFile.name} (${(imageFile.size / 1024).toFixed(2)} KB)`, 'info');
            }
        });

        // Create preset cards
        function createPresetCards() {
            for (const [key, preset] of Object.entries(conversionPresets)) {
                const card = document.createElement('div');
                card.className = 'preset-card';
                card.id = `preset-${key}`;
                card.innerHTML = `
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-description">${preset.description}</div>
                    <button class="preset-button" onclick="window.runPreset('${key}')">
                        Test This Preset
                    </button>
                    <div class="preset-result" id="result-${key}"></div>
                `;
                presetGrid.appendChild(card);
            }
        }

        // Run a single preset
        window.runPreset = async function(presetKey) {
            if (!audioFile) {
                alert('Please select an audio file first');
                return;
            }

            const preset = conversionPresets[presetKey];
            const card = document.getElementById(`preset-${presetKey}`);
            const resultDiv = document.getElementById(`result-${presetKey}`);
            const button = card.querySelector('.preset-button');

            // Update UI
            card.className = 'preset-card running';
            button.disabled = true;
            button.innerHTML = 'Converting... <span class="loading-spinner"></span>';
            resultDiv.innerHTML = '';

            const startTime = Date.now();
            log(`\n=== Testing ${preset.name} ===`, 'info');

            try {
                // Initialize FFmpeg if needed
                await getFFmpeg();

                // Run the conversion
                const blob = presetKey === 'twoPass'
                    ? await runTwoPassConversion(audioFile, imageFile, getAudioExt())
                    : await runConversion(preset, audioFile, imageFile, getAudioExt());

                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                const sizeKB = (blob.size / 1024).toFixed(2);

                // Get video duration by loading it into a video element
                const url = URL.createObjectURL(blob);
                const video = document.createElement('video');
                video.src = url;

                // Wait for metadata to load to get duration
                await new Promise((resolve) => {
                    video.addEventListener('loadedmetadata', () => {
                        resolve();
                    });
                    video.load();
                });

                const videoDuration = video.duration.toFixed(2);

                // Store result
                results[presetKey] = {
                    success: true,
                    size: blob.size,
                    sizeKB,
                    duration,
                    videoDuration,
                    blob
                };

                // Update UI
                card.className = 'preset-card success';
                button.innerHTML = 'Test This Preset';
                button.disabled = false;

                resultDiv.innerHTML = `
                    <div class="stats">
                        <span class="stat">‚úÖ ${sizeKB} KB</span>
                        <span class="stat">üé¨ ${videoDuration}s video</span>
                        <span class="stat">‚è±Ô∏è ${duration}s to generate</span>
                    </div>
                    <video class="preset-video" src="${url}" controls></video>
                `;

                log(`‚úÖ ${preset.name} succeeded: ${sizeKB} KB, ${videoDuration}s video, generated in ${duration}s`, 'success');

            } catch (error) {
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                const errorMsg = error?.message || String(error) || 'Unknown error';

                results[presetKey] = {
                    success: false,
                    error: errorMsg,
                    duration
                };

                card.className = 'preset-card error';
                button.innerHTML = 'Test This Preset';
                button.disabled = false;

                resultDiv.innerHTML = `<div style="color: #ff6666;">‚ùå ${errorMsg}</div>`;
                log(`‚ùå ${preset.name} failed: ${errorMsg}`, 'error');
            }

            updateComparisonTable();
        };

        // Run all tests
        window.runAllTests = async function() {
            if (!audioFile) {
                alert('Please select an audio file first');
                return;
            }

            log('\nüöÄ Running all presets...', 'warning');

            for (const key of Object.keys(conversionPresets)) {
                await runPreset(key);
            }

            log('‚úÖ All tests complete!', 'success');
        };

        // Clear results
        window.clearResults = function() {
            Object.keys(conversionPresets).forEach(key => {
                const card = document.getElementById(`preset-${key}`);
                card.className = 'preset-card';
                const resultDiv = document.getElementById(`result-${key}`);
                resultDiv.innerHTML = '';
            });

            Object.keys(results).forEach(key => delete results[key]);
            document.getElementById('comparisonTable').style.display = 'none';
            logEl.innerHTML = '';
            log('Results cleared', 'info');
        };

        // Update comparison table
        function updateComparisonTable() {
            const hasResults = Object.keys(results).length > 0;
            document.getElementById('comparisonTable').style.display = hasResults ? 'block' : 'none';

            if (!hasResults) return;

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            // Find best/worst for highlighting
            const successfulResults = Object.entries(results).filter(([_, r]) => r.success);
            const sizes = successfulResults.map(([_, r]) => r.size);
            const times = successfulResults.map(([_, r]) => parseFloat(r.duration));
            const minSize = Math.min(...sizes);
            const maxSize = Math.max(...sizes);
            const minTime = Math.min(...times);
            const maxTime = Math.max(...times);

            Object.entries(results).forEach(([key, result]) => {
                const preset = conversionPresets[key];
                const row = tbody.insertRow();

                row.insertCell().textContent = preset.name;

                const sizeCell = row.insertCell();
                if (result.success) {
                    sizeCell.textContent = `${result.sizeKB} KB`;
                    if (result.size === minSize) sizeCell.className = 'best';
                    if (result.size === maxSize) sizeCell.className = 'worst';
                } else {
                    sizeCell.textContent = '-';
                }

                const videoDurationCell = row.insertCell();
                videoDurationCell.textContent = result.videoDuration ? `${result.videoDuration}s` : '-';

                const timeCell = row.insertCell();
                timeCell.textContent = `${result.duration}s`;
                if (result.success) {
                    const time = parseFloat(result.duration);
                    if (time === minTime) timeCell.className = 'best';
                    if (time === maxTime) timeCell.className = 'worst';
                }

                const statusCell = row.insertCell();
                statusCell.textContent = result.success ? '‚úÖ' : '‚ùå';
                statusCell.style.color = result.success ? '#00ff00' : '#ff6666';
            });
        }

        // Download comparison as CSV
        window.downloadComparison = function() {
            if (Object.keys(results).length === 0) {
                alert('No results to download');
                return;
            }

            let csv = 'Preset,File Size (KB),Video Duration (s),Generation Time (s),Status\n';
            Object.entries(results).forEach(([key, result]) => {
                const preset = conversionPresets[key];
                csv += `"${preset.name}",${result.sizeKB || '-'},${result.videoDuration || '-'},${result.duration},${result.success ? 'Success' : 'Failed'}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ffmpeg-comparison-${Date.now()}.csv`;
            a.click();
        };

        // Helper to get audio extension
        function getAudioExt() {
            return audioFile ? audioFile.name.split('.').pop()?.toLowerCase() || 'mp3' : 'mp3';
        }

        // Initialize
        createPresetCards();
        log('Ready! Select files and test different presets.', 'info');

        // Try loading default test file
        fetch('/zoom.m4a')
            .then(response => response.blob())
            .then(blob => {
                audioFile = new File([blob], 'zoom.m4a', { type: 'audio/m4a' });
                document.getElementById('audioFile').files = new DataTransfer().files;
                log('Loaded default test file: zoom.m4a', 'success');
            })
            .catch(() => {
                log('No default test file found', 'warning');
            });

        }); // End of module import
    </script>
</body>
</html>